name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.0). If empty, uses the ref tag."
        required: false
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      ref: ${{ steps.version.outputs.ref }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}
      - id: version
        name: Validate tag matches VERSION
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(cat VERSION | tr -d '\r\n' | xargs)"
          if [[ -z "$VERSION" ]]; then
            echo "VERSION is empty" >&2
            exit 1
          fi

          TAG_INPUT="${{ inputs.tag }}"
          if [[ -n "$TAG_INPUT" ]]; then
            TAG="$TAG_INPUT"
            REF="refs/tags/$TAG"
          else
            if [[ "${GITHUB_REF_TYPE}" != "tag" ]]; then
              echo "workflow_dispatch requires inputs.tag (e.g. v0.1.0) when not running on a tag ref" >&2
              exit 1
            fi
            TAG="${GITHUB_REF_NAME}"
            REF="${GITHUB_REF}"
          fi

          if [[ "$TAG" != v* ]]; then
            echo "Tag must start with 'v' (got '$TAG')" >&2
            exit 1
          fi

          TAG_VERSION="${TAG#v}"
          if [[ "$TAG_VERSION" != "$VERSION" ]]; then
            echo "Tag version '$TAG_VERSION' does not match VERSION '$VERSION'" >&2
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Verify version sync
        shell: bash
        run: |
          set -euo pipefail
          bash ./tools/scripts/version_sync.sh --verify

  test-ubuntu:
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.ref }}
      - uses: dtolnay/rust-toolchain@stable
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Test (Rust workspace)
        working-directory: rust
        run: cargo test --workspace
      - name: Test (Example Rust crates)
        shell: bash
        run: |
          set -euo pipefail
          examples=(
            "examples/counter_app/rust"
            "examples/todos_app/rust"
            "examples/ticker_app/rust"
            "examples/benchmark_app/rust"
          )
          for dir in "${examples[@]}"; do
            (cd "$dir" && cargo test)
          done
      - name: Test oxide_runtime
        working-directory: flutter/oxide_runtime
        run: flutter test
      - name: Test oxide_generator
        working-directory: flutter/oxide_generator
        run: dart test
      - name: Analyze oxide_annotations
        working-directory: flutter/oxide_annotations
        run: dart analyze
      - name: Test examples (Flutter tests)
        shell: bash
        run: |
          set -euo pipefail
          examples=(
            "examples/counter_app"
            "examples/todos_app"
            "examples/ticker_app"
            "examples/benchmark_app"
          )
          for dir in "${examples[@]}"; do
            (
              cd "$dir"
              flutter pub get
              dart run build_runner build -d
              flutter test
            )
          done

  test-windows:
    runs-on: windows-latest
    needs: [validate]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.ref }}
      - uses: dtolnay/rust-toolchain@stable
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Enable Windows desktop and list devices
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Set-StrictMode -Version Latest
          flutter config --enable-windows-desktop
          flutter doctor -v
          flutter devices
      - name: Test examples (Windows integration tests)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Set-StrictMode -Version Latest
          function Invoke-Native {
            param(
              [Parameter(Mandatory = $true)][string]$Command,
              [Parameter(ValueFromRemainingArguments = $true)][string[]]$Args
            )
            & $Command @Args
            $exitCode = $LASTEXITCODE
            if ($exitCode -ne 0) {
              throw "Command failed ($exitCode): $Command $($Args -join ' ')"
            }
          }
          $exampleDirs = @(
            "examples\counter_app",
            "examples\todos_app",
            "examples\ticker_app",
            "examples\benchmark_app"
          )
          foreach ($dir in $exampleDirs) {
            Push-Location $dir
            try {
              Invoke-Native flutter pub get
              Invoke-Native dart @("run", "build_runner", "build", "-d")
              Invoke-Native flutter test
              if (Test-Path "integration_test") {
                $tests = Get-ChildItem -Path "integration_test" -Filter "*_test.dart" -File
                foreach ($test in $tests) {
                  Invoke-Native flutter @("test", "-d", "windows", $test.FullName)
                }
              }
            } finally {
              Pop-Location
            }
          }

  publish-rust:
    runs-on: ubuntu-latest
    needs: [validate, test-ubuntu, test-windows]
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      VERSION: ${{ needs.validate.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.ref }}
      - uses: dtolnay/rust-toolchain@stable
      - name: Publish oxide_core
        if: ${{ env.CARGO_REGISTRY_TOKEN != '' }}
        working-directory: rust
        shell: bash
        run: |
          set -euo pipefail
          output=""
          if ! output="$(cargo publish -p oxide_core 2>&1)"; then
            exit_code="$?"
            printf '%s\n' "$output"
            if printf '%s\n' "$output" | grep -qiE '(already (uploaded|exists)|is already uploaded|previously published)'; then
              echo "oxide_core@$VERSION is already published; skipping."
              exit 0
            fi
            exit "$exit_code"
          fi
          printf '%s\n' "$output"
      - name: Publish oxide_generator_rs
        if: ${{ env.CARGO_REGISTRY_TOKEN != '' }}
        working-directory: rust
        shell: bash
        run: |
          set -euo pipefail
          output=""
          if ! output="$(cargo publish -p oxide_generator_rs 2>&1)"; then
            exit_code="$?"
            printf '%s\n' "$output"
            if printf '%s\n' "$output" | grep -qiE '(already (uploaded|exists)|is already uploaded|previously published)'; then
              echo "oxide_generator_rs@$VERSION is already published; skipping."
              exit 0
            fi
            exit "$exit_code"
          fi
          printf '%s\n' "$output"

  publish-flutter:
    runs-on: ubuntu-latest
    needs: [validate, test-ubuntu, test-windows]
    environment: pub.dev
    env:
      VERSION: ${{ needs.validate.outputs.version }}
    permissions:
      id-token: write 
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.ref }}
      - name: Setup Dart (OIDC for pub.dev)
        uses: dart-lang/setup-dart@v1
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Publish oxide_annotations
        working-directory: flutter/oxide_annotations
        shell: bash
        run: |
          set -uo pipefail
          log="$(mktemp)"
          dart pub publish --force 2>&1 | tee "$log"
          exit_code="${PIPESTATUS[0]}"
          if [[ "$exit_code" -ne 0 ]]; then
            if grep -qiE '(already (published|exists)|already has version|version.*already)' "$log"; then
              echo "oxide_annotations@$VERSION is already published; skipping."
              exit 0
            fi
            exit "$exit_code"
          fi

      - name: Publish oxide_generator
        working-directory: flutter/oxide_generator
        shell: bash
        run: |
          set -uo pipefail
          log="$(mktemp)"
          dart pub publish --force 2>&1 | tee "$log"
          exit_code="${PIPESTATUS[0]}"
          if [[ "$exit_code" -ne 0 ]]; then
            if grep -qiE '(already (published|exists)|already has version|version.*already)' "$log"; then
              echo "oxide_generator@$VERSION is already published; skipping."
              exit 0
            fi
            exit "$exit_code"
          fi

      - name: Publish oxide_runtime
        working-directory: flutter/oxide_runtime
        shell: bash
        run: |
          set -uo pipefail
          log="$(mktemp)"
          dart pub publish --force 2>&1 | tee "$log"
          exit_code="${PIPESTATUS[0]}"
          if [[ "$exit_code" -ne 0 ]]; then
            if grep -qiE '(already (published|exists)|already has version|version.*already)' "$log"; then
              echo "oxide_runtime@$VERSION is already published; skipping."
              exit 0
            fi
            exit "$exit_code"
          fi
