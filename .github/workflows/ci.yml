name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify version sync
        run: bash ./tools/scripts/version_sync.sh --verify


  rust:
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Test (Rust workspace)
        working-directory: rust
        run: cargo test --workspace
      - name: Test (Example Rust crates)
        shell: bash
        run: |
          set -euo pipefail
          examples=(
            "examples/counter_app/rust"
            "examples/todos_app/rust"
            "examples/ticker_app/rust"
            "examples/benchmark_app/rust"
          )
          for dir in "${examples[@]}"; do
            (cd "$dir" && cargo test)
          done

  flutter:
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Test oxide_runtime
        working-directory: flutter/oxide_runtime
        run: flutter test

      - name: Test oxide_generator
        working-directory: flutter/oxide_generator
        run: dart test

      - name: Analyze oxide_annotations
        working-directory: flutter/oxide_annotations
        run: dart analyze

      - name: Test examples (Flutter tests)
        shell: bash
        run: |
          set -euo pipefail
          examples=(
            "examples/counter_app"
            "examples/todos_app"
            "examples/ticker_app"
            "examples/benchmark_app"
          )
          for dir in "${examples[@]}"; do
            (
              cd "$dir"
              flutter pub get
              dart run build_runner build -d
              flutter test
            )
          done

  examples-windows:
    runs-on: windows-latest
    needs: verify
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Test examples (Windows integration tests)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Set-StrictMode -Version Latest
          function Invoke-Native {
            param(
              [Parameter(Mandatory = $true)][string]$Command,
              [Parameter(ValueFromRemainingArguments = $true)][string[]]$Args
            )
            & $Command @Args
            $exitCode = $LASTEXITCODE
            if ($exitCode -ne 0) {
              throw "Command failed ($exitCode): $Command $($Args -join ' ')"
            }
          }
          $exampleDirs = @(
            "examples\counter_app",
            "examples\todos_app",
            "examples\ticker_app",
            "examples\benchmark_app"
          )
          foreach ($dir in $exampleDirs) {
            Push-Location $dir
            try {
              Invoke-Native flutter pub get
              Invoke-Native dart run build_runner build -d
              Invoke-Native flutter test
              if (Test-Path "integration_test") {
                $tests = Get-ChildItem -Path "integration_test" -Filter "*_test.dart" -File
                foreach ($test in $tests) {
                  Invoke-Native flutter test $test.FullName -d windows
                }
              }
            } finally {
              Pop-Location
            }
          }
